var bldngChart;
$(document).ready(function() {
	// works for up to 9 series
	let c = ["#66bb6a", "#8d6e63", "#EF5350", "#42A5F5", "#000000", "#e6194b", "#008080", "#911eb4", "#0082c8"];
	let lines = ["Solid", "Solid", "ShortDash", "ShortDash", "Solid", "ShortDash", "Dot", "ShortDot", "Solid"];
	let ws = [4, 2, 2, 2, 2, 2, 2, 2, 2];
	let CLEN = 9;

	function getTime(et, x) { return toDate(et).toString().split(" ")[4].slice(0, x); }

	function toDate(et) {
		var d = new Date(0);
		d.setUTCSeconds(et);
		return d;
	}

	// http://www.jacklmoore.com/notes/rounding-in-javascript/
	function round(val, dec) { return Number(Math.round(val+'e'+dec)+'e-'+dec); }

	function processResp(j) {
		var toRet = [];
		for (var z in j) {
			var lst = [];
			var prevKeys = [];
			var st;
			for (var s in j[z]) {
				var toAdd = new Object();
				toAdd.id = clean(z).toLowerCase() + " " + s;
				toAdd.name = toAdd.id;
				if (s == "state") {
					toAdd.data = j[z][s];
					st = toAdd;
				} else {
					var ret = makeData(j[z][s], toAdd.id);
					toAdd.data = ret[0];
					var k = ret[1];
					if (k.length > prevKeys.length) { prevKeys = k; }
					lst.push(toAdd);
				}
			}
			var cleaned = clean(z); lst[0].name = cleaned; lst[0].id = cleaned;
			st.data = makeState(st.data, prevKeys, st.id);
			st.yAxis = 1;
			st.step = "center";
			lst.push(st);
			var i; for (i = 0; i < lst.length; i += 1) {
				lst[i].dashStyle = lines[i];
				lst[i].color = c[i % CLEN];
				lst[i].lineWidth = ws[i];
			}
			// console.log(lst);
			if (!toRet.length) { lst[0].visible = true; }
			else { lst[0].visible = false; }
			$.merge(toRet, lst);
		}
		// console.log(toRet);
		return toRet;
	}
	
	function processPower(j) {
		var toRet = [];
		for (var z in j) {
			console.log(z);
		}
	}

	// make multiple series maybe
	function makeState(j, l, n) {
		var toRet = [];
		var prev = null;
		var col = null;
		var r;
		for (var k in l) {
			var toAdd = new Object();
			toAdd.name = getTime(l[k]/1000, 5);
			toAdd.id = n + " " + toAdd.name;
			if (l[k] in j) {
				r = stateClean(j[l[k]]); 
				prev = round(r[0], 2);
				// col = r[2];
			}
			// toAdd.color = col;
			toAdd.y = prev;
			toAdd.id += " " + r[1];
			toRet.push(toAdd);
		}
		return toRet;
	}

	function stateClean(x) {
		if (x == "off") { return [-2, "off", "#424242"]; }
		if (x == "heat stage 1") { return [2, "he1", "#e57373"]; }
		if (x == "heat stage 2") { return [0, "he2", "#e53935"]; }
		if (x == "cool stage 1") { return [0, "co1", "#64b5f6"]; }
		if (x == "cool stage 2") { return [0, "co2", "#1976d2"]; }
	}

	function makeData(j, n) {
		var toRet = [];
		var ret = [];
		for (var k in j) {
			ret.push(k);
			var toAdd = new Object();
			toAdd.name = getTime(k/1000, 5);
			toAdd.id = n + " " + toAdd.name;
			toAdd.y = round(j[k], 2);
			toRet.push(toAdd);
		}
		return [toRet, ret];
	}

	function clean(s, shorten=false, amt=null) {
		s = s.replace("-", "_");
		s = s.split("_");
		if (shorten && amt) { for (var i in s) { if (s[i].length > amt) { s[i] = s[i].slice(0, amt); }}}
		for (var i in s) { s[i] = s[i].charAt(0).toUpperCase() + s[i].slice(1).toLowerCase(); }
		s = s.join("");
		s = s.replace("Zone", "").replace("ZONE", "").replace("zone", "");
		s = s.replace("HVAC", "").replace("Hvac", "").replace("hvac", "");
		return s;
	}

	function pointFormatter() {
		// if ("state" in this) {
			// last 3 chars
			// return this.id.toString().reverse().slice(3).reverse();
		// }
		// if (state in $(this).id) { return "sdf"; }
		// else { 
		return "<span style='font-size: 14px;'>" + this.id.split(" ")[1] + this.y + "<br/>";
		// }
    }

	var options = {
		"chart": {
			"resetZoomButton": {
				"theme": {
					"display": "none"
				}
			},
			"zoomType": "x",
			"scrollablePlotArea": {
				"minWidth": 450
			},
			"renderTo": "bldng-DR",
			"events": {
				"load": function(e) {
					$.ajax({
						"url": "http://127.0.0.1:5000/api/hvac/day/15m",
						"type": "GET",
						"dataType": "json",
						"success": function(d) { console.log("copy error here"); },
						"error": function(d) {
							var d = {"EastZone": { "inside": { "1520322778000": 30, "1520326378000": 69.204815864, "1520329978000": 69.2362606232, "1520333578000": 69.2615819209, "1520337178000": 69.2750708215, "1520340778000": 69.2776203966, "1520344378000": 69.2759206799, "1520347978000": 69.5719546742, "1520351578000": 69.2436260623, "1520355178000": 69.6504249292, "1520358778000": 70.0016997167, "1520362378000": 70.3898550725, "1520365978000": 70.4116147309, "1520369578000": 70.6051136364, "1520373178000": 70.728125, "1520376778000": 70.856980057, "1520380378000": 71.547592068, "1520383978000": 72.1147727273 }, "outside": { "1520322778000": 89.49, "1520326378000": 89.2, "1520329978000": 89.22, "1520333578000": 89.29, "1520337178000": 89.25, "1520340778000": 89.26, "1520344378000": 89.29, "1520347978000": 89.52, "1520351578000": 89.23, "1520355178000": 89.62, "1520358778000": 80.07, "1520362378000": 80.35, "1520365978000": 80.49, "1520369578000": 80.64, "1520373178000": 80.7, "1520376778000": 80.8, "1520380378000": 81.5, "1520383978000": 82.13 }, "heating_setpoint": { "1520322778000": 50, "1520326378000": 50, "1520329978000": 50, "1520333578000": 50, "1520337178000": 50, "1520340778000": 50, "1520344378000": 50, "1520347978000": 50, "1520351578000": 50, "1520355178000": 50, "1520358778000": 70, "1520362378000": 70, "1520365978000": 70, "1520369578000": 70, "1520373178000": 70, "1520376778000": 70, "1520380378000": 70, "1520383978000": 70 }, "cooling_setpoint": { "1520322778000": 80, "1520326378000": 80, "1520329978000": 80, "1520333578000": 80, "1520337178000": 80, "1520340778000": 80, "1520344378000": 80, "1520347978000": 80, "1520351578000": 80, "1520355178000": 80, "1520358778000": 74, "1520362378000": 74, "1520365978000": 74, "1520369578000": 74, "1520373178000": 74, "1520376778000": 74, "1520380378000": 74, "1520383978000": 74 }, "state": { "1520322778000": "heat stage 1", "1520329978000": "off", "1520358778000": "heat stage 1", "1520365978000": "heat stage 2", "1520369578000": "off", "1520373178000": "heat stage 1" }}};
							var a = processResp(d);
							console.log(a);

							for (var x = 0; x < a.length; x += 1) { bldngChart.addSeries(a[x], false); }
							$("#bldng-reset").addClass("scale-in");
						},
						"complete": function(d) {
							$.ajax({
								"url": "http://127.0.0.1:5000/api/hvac/day/15m",
								"type": "GET",
								"dataType": "json",
								"success": function(d) { console.log("woah"); },
								"error": function (d) {
									var d = { "site": "avenal-animal-shelter", "date": "07-19-2018", "cost": { 	"actual": 17.23, 	"baseline:": 57.80 }, "baseline-type": "Linear Regression", "degree-hours": { 	"cooling": 5,  	"heating": 0 }, "rmse": 1234, "actual": { "1531987200000": 8288.0, "1531988100000": 6176.0,"1531989000000": 7552.0,"1531989900000": 4640.0,"1531990800000": 6432.0,"1531991700000": 5824.0,"1531992600000": 5024.0,"1531993500000": 6752.0,"1531994400000": 3744.0,"1531995300000": 6592.0,"1531996200000": 4320.0,"1531997100000": 5920.0,"1531998000000": 4704.0,"1531998900000": 5248.0,"1531999800000": 4736.0,"1532000700000": 5056.0,"1532001600000": 4608.0,"1532002500000": 5280.0,"1532003400000": 3936.0,"1532004300000": 6112.0,"1532005200000": 3808.0,"1532006100000": 5984.0,"1532007000000": 3712.0,"1532007900000": 4544.0,"1532008800000": 4224.0,"1532009700000": 4160.0,"1532010600000": 5792.0,"1532011500000": 7072.0,"1532012400000": 9856.0,"1532013300000": 7232.0,"1532014200000": 9664.0,"1532015100000": 11744.0,"1532016000000": 7968.0,"1532016900000": 11168.0,"1532017800000": 10272.0,"1532018700000": 10048.0,"1532019600000": 11296.0,"1532020500000": 11328.0,"1532021400000": 11776.0,"1532022300000": 11648.0,"1532023200000": 10976.0,"1532024100000": 11680.0,"1532025000000": 10688.0,"1532025900000": 10880.0,"1532026800000": 10880.0,"1532027700000": 11168.0,"1532028600000": 10752.0,"1532029500000": 10880.0,"1532030400000": 11072.0,"1532031300000": 11616.0,"1532032200000": 11648.0,"1532033100000": 11424.0,"1532034000000": 11520.0,"1532034900000": 10240.0,"1532035800000": 9824.0,"1532036700000": 9824.0,"1532037600000": 9888.0,"1532038500000": 9792.0,"1532039400000": 9024.0,"1532040300000": 7968.0,"1532041200000": 2752.0,"1532042100000": 2208.0,"1532043000000": 2336.0,"1532043900000": 2144.0,"1532044800000": 2176.0,"1532045700000": 2112.0,"1532046600000": 3040.0,"1532047500000": 3040.0,"1532048400000": 3200.0,"1532049300000": 3040.0,"1532050200000": 3104.0,"1532051100000": 3104.0,"1532052000000": 3104.0,"1532052900000": 3040.0,"1532053800000": 3168.0,"1532054700000": 3072.0,"1532055600000": 3072.0,"1532056500000": 3264.0,"1532057400000": 3488.0,"1532058300000": 3552.0,"1532059200000": 3520.0,"1532060100000": 3648.0,"1532061000000": 3520.0,"1532061900000": 3584.0,"1532062800000": 3552.0,"1532063700000": 3616.0,"1532064600000": 3776.0,"1532065500000": 3872.0,"1532066400000": 3680.0,"1532067300000": 3712.0,"1532068200000": 3776.0,"1532069100000": 3712.0,"1532070000000": 7456.0,"1532070900000": 7296.0,"1532071800000": 8224.0,"1532072700000": 7328.0}, "baseline": {"1531987200000": 6112.2582947533,"1531988100000": 5886.2757730824,"1531989000000": 5905.797098581,"1531989900000": 5830.4922073292,"1531990800000": 5870.6539607671,"1531991700000": 5965.522790993,"1531992600000": 6082.5210828037,"1531993500000": 5873.018816445,"1531994400000": 5883.9235392837,"1531995300000": 6049.6622700668,"1531996200000": 5879.8955545917,"1531997100000": 5976.2121517736,"1531998000000": 5953.7940794453,"1531998900000": 6128.3600258063,"1531999800000": 6187.1117425467,"1532000700000": 6142.9308679995,"1532001600000": 6137.6109532295,"1532002500000": 6250.5110730454,"1532003400000": 6195.5910716133,"1532004300000": 6171.1596047953,"1532005200000": 6147.7921226955,"1532006100000": 6171.1235838498,"1532007000000": 6349.1486299907,"1532007900000": 6855.5766550708,"1532008800000": 6742.4515722136,"1532009700000": 7668.4337130427,"1532010600000": 7956.2314959764,"1532011500000": 7033.5119757067,"1532012400000": 7189.2079608189,"1532013300000": 7415.0021332475,"1532014200000": 7325.4107766511,"1532015100000": 7437.6683187248,"1532016000000": 6815.0152832476,"1532016900000": 7614.7597387976,"1532017800000": 7343.5747732898,"1532018700000": 7291.9484131168,"1532019600000": 7294.2066667962,"1532020500000": 8074.8520852154,"1532021400000": 8256.8172548345,"1532022300000": 8214.6241697188,"1532023200000": 8390.7825812724,"1532024100000": 8426.8276361719,"1532025000000": 8569.7626683791,"1532025900000": 8935.9238803159,"1532026800000": 8864.4201954005,"1532027700000": 8834.6091384007,"1532028600000": 8964.2128827066,"1532029500000": 9106.1186135505,"1532030400000": 8365.1896562182,"1532031300000": 9234.6192920215,"1532032200000": 9629.2101665116,"1532033100000": 9790.4228519642,"1532034000000": 9711.0532467391,"1532034900000": 11093.0072920412,"1532035800000": 9977.5529900508,"1532036700000": 10158.3761171804,"1532037600000": 9152.3579343971,"1532038500000": 9368.644978239,"1532039400000": 9350.6024434603,"1532040300000": 8250.0825350084,"1532041200000": 6727.8125933579,"1532042100000": 6765.7107693642,"1532043000000": 6398.7204143929,"1532043900000": 6332.7749423576,"1532044800000": 6426.8331791861,"1532045700000": 6320.39927059,"1532046600000": 6851.3380024049,"1532047500000": 6862.9610282626,"1532048400000": 6854.6750809061,"1532049300000": 7090.7625882138,"1532050200000": 7059.9024721466,"1532051100000": 7027.8507982798,"1532052000000": 7149.7262656498,"1532052900000": 7049.6946829567,"1532053800000": 7021.1783507146,"1532054700000": 7109.1216127991,"1532055600000": 6935.1382690738,"1532056500000": 6923.8815037056,"1532057400000": 6808.6239442723,"1532058300000": 6926.7680833175,"1532059200000": 6911.213728841,"1532060100000": 6794.9384439198,"1532061000000": 6838.7548352,"1532061900000": 6831.0412213237,"1532062800000": 7243.6396362357,"1532063700000": 7146.5221386009,"1532064600000": 7583.0896361193,"1532065500000": 7571.2847804977,"1532066400000": 7158.5097189514,"1532067300000": 7128.9881057194,"1532068200000": 7048.0634822738,"1532069100000": 7017.9355528776,"1532070000000": 7190.8282144389,"1532070900000": 7506.0903381235,"1532071800000": 7407.8510265452,"1532072700000": 6986.4318754599 }};
									var a = processPower(d);
									// var a = processResp(d);
									// console.log(a);
									console.log("hi");
								},
								"complete": function(d) {
									bldngChart.hideLoading();
									bldngChart.redraw();
								}
							});
						}
					});
				}
			}
		},
		"title": {
			"text": "Baseline (Building)"
		},
		"loading": {
			"hideDuration": 0,
			"showDuration": 0,
			"style": {
				"opacity": .75
			}
		},
		"xAxis": [
			{
				"id": "myXAxis",
				"type": "category",
				"plotBands": {
					"color": "#F7B4B6",
					"from": 14,
					"to": 18
				}
			}
		],
		"yAxis": [
			{
				"title": { "text": "Â°F" },
				"height": 225
			},
			{
				"height": 60,
				"top": 300,
				"visible": false
			},
			{
				"title": { "text": "kW" },
				"height": 225,
				"opposite": true
			}
		],
		"credits": {
			"enabled": false
		},
		"legend": {
			"enabled": false
		},
		"plotOptions": {
			"line": {
				"marker": {
					"enabled": false,
				}
			},
			"series": {
				"stickyTracking": true,
				"states": {
					"hover": {
						"enabled": false
					}
				},
				"events": {
					// "legendItemClick": function () {
						// var s = this.chart.series;
						// for (var i = 0; i < s.length; i += 1) {
							// s[i].hide();
						// }
						// bldngChart.setTitle(null, { text: "Zone: " + this.name} );
						// return true;
					// }
				}
			}
		},
		"tooltip": {
			"headerFormat": '<span style="font-size:14px">{point.key}</span><br/>',
			"pointFormatter": pointFormatter,
			"hideDelay": 500,
			"shared": true,
			"crosshairs": true,
			"padding": 6
		},
		"series": []
	};

	bldngChart = new Highcharts.Chart(options);
	bldngChart.showLoading();

	$('#bldng-reset').click(function() { bldngChart.xAxis[0].setExtremes(null, null); });
});

